# MidasLira

WPF-приложение для передачи жесткостей фундаментов из MIDAS Civil в ЛИРА-САПР.

## Описание

MidasLira — это инструмент для инженеров-конструкторов, который автоматизирует процесс передачи расчетных данных между двумя популярными программными комплексами для расчета конструкций:
- **MIDAS Civil** — результаты расчета напряжений и перемещений
- **ЛИРА-САПР** — модель расчетной схемы

Приложение выполняет:
- Чтение данных из Excel-файла (узлы и элементы MIDAS, узлы и элементы ЛИРА, напряжения)
- Сопоставление узлов и элементов по координатам
- Расчет коэффициентов постели (C1) на основе напряжений и перемещений
- Запись жесткостей узлов в раздел (3/) файла ЛИРА-САПР
- Запись элементов КЭ56 в раздел (1/)
- Запись коэффициентов постели в раздел (19/)

## Структура проекта

```
MidasLira/
├── MidasLira/                  # Основное WPF-приложение
│   ├── App.xaml                # Точка входа приложения
│   ├── MainWindow.xaml         # Главное окно с выбором режима
│   ├── PlateFoundationWindow.xaml   # Окно для плитных фундаментов
│   ├── PileFoundationStubWindow.xaml # Окно для свайных фундаментов (заглушка)
│   ├── DataProcessor.cs        # Главный класс обработки данных
│   ├── ExcelReader.cs          # Чтение данных из Excel
│   ├── Mapper.cs               # Сопоставление узлов/элементов и структуры данных
│   ├── RigidityCalculator.cs   # Расчет жесткостей узлов
│   ├── Writer.cs               # Запись данных в файл ЛИРА-САПР
│   ├── PositionFinder.cs       # Парсинг структуры файла ЛИРА-САПР
│   └── Logger.cs               # Логирование операций
├── MidasLira.Tests/            # Модульные тесты (xUnit)
└── .github/workflows/           # GitHub Actions CI/CD
```

## Требования

- .NET 8.0 SDK
- Windows 10/11 (для запуска WPF-приложения)
- EPPlus 8.1.1 (для работы с Excel)

## Установка и запуск

### Сборка из исходников

```bash
# Клонирование репозитория
git clone <url>
cd MidasLira

# Восстановление зависимостей
dotnet restore MidasLira.sln

# Сборка
dotnet build MidasLira.sln --configuration Release

# Запуск
dotnet run --project MidasLira/MidasLira.csproj
```

### Запуск тестов

```bash
dotnet test MidasLira.Tests/MidasLira.Tests.csproj
```

## Использование

1. **Подготовка Excel-файла** с обязательными листами:
   - `Sheet1` — узлы MIDAS (Id, X, Y, Z, NodeDisplacement)
   - `Sheet2` — узлы ЛИРА-САПР (Id, X, Y, Z)
   - `Sheet3` — элементы MIDAS (Id, Node1, Node2, Node3, Node4)
   - `Sheet4` — элементы ЛИРА-САПР (Id, Node1, Node2, Node3, Node4)
   - `Sheet5` — напряжения (ElementId, Node1-8, StressValue)

2. **Запуск приложения** и выбор режима:
   - **Плиты** — для плитных фундаментов
   - **Свайные фундаменты** — для свайных фундаментов (в разработке)

3. **Указание файлов**:
   - Excel-файл с данными MIDAS
   - Файл расчетной схемы ЛИРА-САПР (.txt)

4. **Обработка** — приложение автоматически:
   - Создает резервную копию файла ЛИРА-САПР
   - Записывает жесткости узлов
   - Записывает элементы КЭ56
   - Записывает коэффициенты постели

## Алгоритм работы

1. **Чтение данных** (`ExcelReader.cs`)
   - Чтение узлов и элементов MIDAS
   - Чтение узлов и элементов ЛИРА-САПР
   - Чтение напряжений из объемных элементов

2. **Сопоставление** (`Mapper.cs`)
   - Сопоставление узлов по координатам (X, Y, Z)
   - Сопоставление элементов по совпадающим узлам
   - Кластеризация элементов в плиты

3. **Расчет** (`RigidityCalculator.cs`)
   - Расчет коэффициента постели: C1 = Stress / Displacement
   - Расчет площади плиты
   - Расчет жесткости узлов: rigidNodes = (Area × avgC1 × 0.7) / Elements.Count

4. **Запись** (`Writer.cs`)
   - Запись жесткостей в раздел (3/)
   - Запись элементов КЭ56 в раздел (1/)
   - Запись коэффициентов постели в раздел (19/)

## CI/CD

Проект использует GitHub Actions для автоматической сборки и тестирования:

- Сборка на Ubuntu с .NET 8.0
- Восстановление зависимостей
- Сборка в конфигурации Release
- Запуск модульных тестов
- Проверка форматирования кода
- Артефакты сборки

## Архитектура

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  MainWindow     │────▶│ DataProcessor   │────▶│  ExcelReader    │
│  (WPF UI)       │     │  (Orchestrator) │     │  (Input)        │
└─────────────────┘     └─────────────────┘     └─────────────────┘
                                │
                                ▼
                       ┌─────────────────┐
                       │     Mapper      │
                       │ (Node/Element   │
                       │  Mapping)       │
                       └─────────────────┘
                                │
                ┌───────────────┼───────────────┐
                ▼               ▼               ▼
       ┌─────────────────┐ ┌─────────────────┐ ┌─────────────────┐
       │ RigidityCalculator│ │    Writer       │ │ PositionFinder  │
       │ (Calculations)  │ │  (Output)       │ │ (File Parser)   │
       └─────────────────┘ └─────────────────┘ └─────────────────┘
```
